<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Grist — Contact (Upsert par entreprise)</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
      :root { --gap: 14px; --radius: 12px; --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; }
      html, body { height: 100%; }
      body { margin: 0; font-family: var(--font); background: #0b0f14; color: #e6edf3; }
      .wrap { max-width: 620px; margin: 0 auto; padding: 24px; }
      .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
      h1 { font-size: 1.2rem; margin: 0 0 6px; }
      p.desc { margin: 0 0 14px; color: #9fb0c0; font-size: .95rem; }
      form { display: grid; gap: var(--gap); }
      .row { display: grid; gap: 8px; }
      label { font-size: .9rem; color: #b9c7d6; }
      input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #293548; background: #0f172a; color: #e6edf3; }
      input[readonly] { opacity: .85; }
      .actions { display: flex; gap: 10px; align-items: center; }
      button { border: 0; border-radius: 10px; padding: 10px 14px; background: #2563eb; color: white; cursor: pointer; }
      button.secondary { background: #334155; }
      button:disabled { opacity: .6; cursor: wait; }
      .muted { color: #9fb0c0; font-size: .9rem; }
      .msg { margin-top: 12px; font-size: .95rem; }
      .ok { color: #22c55e; }
      .err { color: #f87171; white-space: pre-wrap; }
      .hidden { display: none !important; }
      .sep { height: 1px; background: #1f2937; margin: 14px 0; }
      .badge { display:inline-block; padding: 2px 8px; border:1px solid #2b3a4c; border-radius:999px; font-size:.8rem; color:#9fb0c0; }
      code.kv { background:#0f172a; padding:2px 6px; border-radius:6px; border:1px solid #293548; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Contact — ajout / mise à jour</h1>
        <p class="desc">1) Renseigne l'entreprise puis clique <strong>Vérifier</strong>.<br>2) Si elle existe, le formulaire est pré-rempli. Sinon, un contact sera créé.</p>

        <details class="muted" id="diag" open>
          <summary>Diagnostic</summary>
          <div id="diagBody" class="muted"></div>
        </details>

        <!-- Étape 1 : recherche par entreprise -->
        <form id="searchForm" autocomplete="off">
          <div class="row">
            <label for="companySearch">Entreprise</label>
            <input id="companySearch" name="company" type="text" placeholder="Nom de l’entreprise" required>
          </div>
          <div class="actions">
            <button id="btnCheck" type="submit">Vérifier</button>
            <span id="searchInfo" class="muted"></span>
          </div>
        </form>

        <div class="sep"></div>

        <!-- Étape 2 : édition / création -->
        <form id="editForm" class="hidden" autocomplete="off">
          <div class="row">
            <label for="company">Entreprise <span class="badge">clé de déduplication</span></label>
            <input id="company" name="company" type="text" readonly required>
            <div class="actions">
              <button type="button" class="secondary" id="changeCompany">Changer d’entreprise</button>
            </div>
          </div>

          <div class="row">
            <label for="first_name">Prénom</label>
            <input id="first_name" name="first_name" type="text" placeholder="Prénom" required>
          </div>

          <div class="row">
            <label for="last_name">Nom</label>
            <input id="last_name" name="last_name" type="text" placeholder="Nom" required>
          </div>

          <div class="actions">
            <button id="btnSave" type="submit">Enregistrer</button>
            <span id="editInfo" class="muted"></span>
          </div>

          <div id="msg" class="msg"></div>
        </form>
      </div>
    </div>

    <script type="module">
      // === Configuration minimale =============================================
      const TABLE_ID = 'contact';
      const COLS = { first: 'first_name', last: 'last_name', company: 'company' };
      // =========================================================================

      let docId = null;
      let token = null;
      let apiBase = null;

      const els = {
        diagBody: document.getElementById('diagBody'),
        searchForm: document.getElementById('searchForm'),
        companySearch: document.getElementById('companySearch'),
        btnCheck: document.getElementById('btnCheck'),
        searchInfo: document.getElementById('searchInfo'),

        editForm: document.getElementById('editForm'),
        changeCompany: document.getElementById('changeCompany'),
        company: document.getElementById('company'),
        first: document.getElementById('first_name'),
        last: document.getElementById('last_name'),
        btnSave: document.getElementById('btnSave'),
        editInfo: document.getElementById('editInfo'),
        msg: document.getElementById('msg'),
      };

      const urlParams = new URLSearchParams(location.search);
      const apiBaseOverride = (urlParams.get('apiBase') || '').replace(/\/+$/, '');

      function logDiag(lines) {
        const arr = Array.isArray(lines) ? lines : [lines];
        for (const l of arr) {
          const p = document.createElement('div');
          p.innerHTML = l;
          els.diagBody.appendChild(p);
        }
      }

      logDiag([
        '<div>Mode: <code class="kv">module</code></div>',
        apiBaseOverride ? `<div>apiBase override: <code class="kv">${apiBaseOverride}</code></div>` : '<div>apiBase override: <code class="kv">none</code></div>'
      ]);

      function setBusy(node, busy) { busy ? node.setAttribute('disabled','') : node.removeAttribute('disabled'); }
      function show(node) { node.classList.remove('hidden'); }
      function hide(node) { node.classList.add('hidden'); }
      function note(text, cls='') { els.msg.textContent = text || ''; els.msg.className = 'msg ' + (cls || ''); }

      function api(path, opts={}) {
        const headers = Object.assign({'Content-Type': 'application/json'}, opts.headers || {});
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const base = apiBase || apiBaseOverride;
        if (!base) return Promise.reject(new Error('API non initialisée : pas de base URL (token non obtenu ? access level Full ?)'));
        return fetch(`${base}${path}`, {...opts, headers}).then(async res => {
          if (!res.ok) {
            const body = await res.text();
            throw new Error(`${res.status} ${res.statusText}\n${body}`);
          }
          return res.json();
        });
      }

      function findByCompany(company) {
        const body = { filters: { [COLS.company]: [company] }, limit: 1 };
        const path = `/api/docs/${docId}/tables/${TABLE_ID}/records/query`;
        return api(path, { method: 'POST', body: JSON.stringify(body) })
          .then(out => (out.records && out.records[0]) ? out.records[0] : null);
      }

      function upsertContact({first, last, company}) {
        const body = {
          records: [{
            require: { [COLS.company]: company },
            fields:  { [COLS.first]: first, [COLS.last]: last, [COLS.company]: company }
          }],
          add: true, update: true, onMany: 'first'
        };
        const path = `/api/docs/${docId}/tables/${TABLE_ID}/records`;
        return api(path, { method: 'PUT', body: JSON.stringify(body) });
      }

      function init() {
        grist.ready({ requiredAccess: 'full' });

        // 1) Tente de prendre le token immédiatement (sans onOptions)
        grist.docApi.getAccessToken()
          .then(tok => {
            docId  = tok.docId;
            token  = tok.token;
            apiBase = tok.baseUrl || 'https://docs.getgrist.com';
            logDiag([
              `<div>docId: <code class="kv">${docId}</code></div>`,
              `<div>apiBase (token): <code class="kv">${apiBase}</code></div>`
            ]);
          })
          .catch(err => {
            logDiag(`<div class="err">Erreur getAccessToken(): ${err.message}</div>`);
          });

        // 2) En plus, si des options sont changées, on refait le token
        grist.onOptions(() => {
          grist.docApi.getAccessToken()
            .then(tok => {
              docId  = tok.docId;
              token  = tok.token;
              apiBase = tok.baseUrl || 'https://docs.getgrist.com';
              logDiag(`<div>onOptions → token rafraîchi</div>`);
            })
            .catch(err => logDiag(`<div class="err">onOptions getAccessToken(): ${err.message}</div>`));
        });
      }

      els.searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const company = els.companySearch.value.trim();
        if (!company) return;
        setBusy(els.btnCheck, true);
        els.searchInfo.textContent = 'Recherche…';
        note('');

        findByCompany(company)
          .then(rec => {
            show(els.editForm);
            els.company.value = company;
            if (rec) {
              els.first.value = rec.fields[COLS.first] ?? '';
              els.last.value  = rec.fields[COLS.last]  ?? '';
              els.editInfo.textContent = 'Entreprise trouvée — modification possible.';
            } else {
              els.first.value = '';
              els.last.value  = '';
              els.editInfo.textContent = 'Nouvelle entreprise — un contact sera créé.';
            }
          })
          .catch(err => {
            note('Erreur recherche :\n' + err.message, 'err');
          })
          .finally(() => {
            setBusy(els.btnCheck, false);
            els.searchInfo.textContent = '';
          });
      });

      els.changeCompany.addEventListener('click', () => {
        hide(els.editForm);
        els.companySearch.focus();
        note('');
      });

      els.editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const payload = {
          first: els.first.value.trim(),
          last:  els.last.value.trim(),
          company: els.company.value.trim(),
        };
        if (!payload.first || !payload.last || !payload.company) {
          note('Merci de renseigner tous les champs.', 'err');
          return;
        }

        setBusy(els.btnSave, true);
        els.editInfo.textContent = 'Enregistrement…';
        note('');

        upsertContact(payload)
          .then(() => note('✔️ Enregistré.', 'ok'))
          .catch(err => note('Erreur enregistrement :\n' + err.message, 'err'))
          .finally(() => {
            setBusy(els.btnSave, false);
            els.editInfo.textContent = '';
          });
      });

      init();
    </script>
  </body>
</html>
